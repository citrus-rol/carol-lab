---
import Navbar from '../components/Navbar.astro';
import WorksCard from '../components/WorksCard.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import BackToTop from '../components/BackToTop.astro';
import Footer from '../components/Footer.astro';

const base = import.meta.env.BASE_URL || '/';

interface Work {
  title: string;
  date: string;
  image: string;
  link: string;
}

const worksList: Work[] = [
  { title: '字體設計｜主題設計', date: '2025-01-29', image: 'images/works_01_a.svg', link: '01_typography_theme' },
  { title: '字體設計｜主題設計', date: '2025-02-05', image: 'images/works_02_a.svg', link: '02_typography_theme' },
  { title: '字體設計｜主題設計', date: '2025-02-13', image: 'images/works_03_a.svg', link: '03_typography_theme' },
  { title: '字體設計｜主題設計', date: '2025-02-19', image: 'images/works_04_a.svg', link: '04_typography_theme' },
  { title: '字體設計｜主題設計', date: '2025-02-26', image: 'images/works_05_a.svg', link: '05_typography_theme' },
  { title: '字體設計｜主題設計', date: '2025-03-25', image: 'images/works_06_a.svg', link: '06_typography_theme' },
  { title: '字體設計｜音樂視覺', date: '2025-03-12', image: 'images/works_07_a.svg', link: '01_typography_music_visual' },
  { title: '字體設計｜音樂視覺', date: '2025-03-20', image: 'images/works_08_a.svg', link: '02_typography_music_visual' },
  { title: '字體設計｜音樂視覺', date: '2025-03-26', image: 'images/works_09_a.svg', link: '03_typography_music_visual' },
  { title: '字體設計｜音樂視覺', date: '2025-04-02', image: 'images/works_10_a.svg', link: '04_typography_music_visual' },
  { title: '字體設計｜音樂視覺', date: '2025-04-09', image: 'images/works_11_a.svg', link: '05_typography_music_visual' },
  { title: '字體設計｜音樂視覺', date: '2025-04-16', image: 'images/works_12_a.svg', link: '06_typography_music_visual' },
];

// Coming Soon
const comingSoonList = [
  { title: 'Coming Soon', date: '____-__-__' },
  { title: 'Coming Soon', date: '____-__-__' },
  { title: 'Coming Soon', date: '____-__-__' },
  { title: 'Coming Soon', date: '____-__-__' },
  { title: 'Coming Soon', date: '____-__-__' },
  { title: 'Coming Soon', date: '____-__-__' },
];

// 顏色背景
const colors = ['#e5af3a33', '#24364033', '#d3d7d933', '#24364033', '#d3d7d933', '#e5af3a33', '#d3d7d933', '#e5af3a33', '#24364033'];
---

<BaseLayout title="作品" mainClass="works-main">
  <Navbar slot="navbar" />

  <!-- 篩選按鈕 -->
  <div class="filter-buttons-container">
    <div class="filter-buttons">
      <button data-filter="all" class="active">全部</button>
      <button data-filter="字體設計｜主題設計">字體設計｜主題設計</button>
      <button data-filter="字體設計｜音樂視覺">字體設計｜音樂視覺</button>
      <button data-filter="Coming Soon">Coming Soon</button>
      <div class="indicator"></div>
    </div>
  </div>

  <!-- 作品卡片 -->
  <main class="works-grid" id="works-grid">
    {worksList.map((work) => {
      const imgSrc = work.image.startsWith(base)
        ? work.image
        : `${base}${work.image.replace(/^\//, '')}`;

      return (
        <a href={`${base}${work.link.replace(/^\//, '')}`} class="fade-in" data-category={work.title}>
          <WorksCard title={work.title} date={work.date} image={imgSrc} />
        </a>
      );
    })}

    {comingSoonList.map((work, index) => {
      const color = colors[index % colors.length];
      const imgSrc = 'data:image/svg+xml;base64,' + btoa(
        `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400" preserveAspectRatio="xMidYMid slice">
          <rect width="400" height="400" fill="${color}"/>
        </svg>`
      );

      return (
        <a class="fade-in" data-category="Coming Soon">
          <WorksCard title={work.title} date={work.date} image={imgSrc} />
        </a>
      );
    })}
  </main>

  <BackToTop />
  <Footer slot="footer" />

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const buttons = document.querySelectorAll<HTMLButtonElement>('.filter-buttons button');
      const worksGrid = document.getElementById('works-grid')!;
      const indicator = document.querySelector<HTMLDivElement>('.indicator')!;
      const container = document.querySelector<HTMLDivElement>('.filter-buttons-container')!;

      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          // active 樣式
          buttons.forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');

          // indicator 移動
          indicator.style.left = btn.offsetLeft + 'px';
          indicator.style.width = btn.offsetWidth + 'px';

          // 確保按鈕在可視範圍
          const btnLeft = btn.offsetLeft;
          const btnRight = btnLeft + btn.offsetWidth;
          const containerScrollLeft = container.scrollLeft;
          const containerWidth = container.offsetWidth;

          if (btnLeft < containerScrollLeft) {
            container.scrollTo({ left: btnLeft, behavior: 'smooth' });
          } else if (btnRight > containerScrollLeft + containerWidth) {
            container.scrollTo({ left: btnRight - containerWidth, behavior: 'smooth' });
          }

          // 篩選卡片
          const filter = btn.dataset.filter!;
          const items = worksGrid.querySelectorAll<HTMLAnchorElement>('a');

          items.forEach((item) => {
            if (filter === 'all' || item.dataset.category === filter) {
              item.classList.remove('fade-out');
              item.classList.add('fade-in');
              item.style.display = 'block';
            } else {
              item.classList.remove('fade-in');
              item.classList.add('fade-out');
              setTimeout(() => { item.style.display = 'none'; }, 300);
            }
          });
        });
      });

      // 初始化 indicator
      const activeBtn = document.querySelector<HTMLButtonElement>('.filter-buttons button.active')!;
      indicator.style.left = activeBtn.offsetLeft + 'px';
      indicator.style.width = activeBtn.offsetWidth + 'px';

      window.addEventListener('resize', () => {
        const activeBtn = document.querySelector<HTMLButtonElement>('.filter-buttons button.active')!;
        indicator.style.left = activeBtn.offsetLeft + 'px';
        indicator.style.width = activeBtn.offsetWidth + 'px';
      });
    });
  </script>

  <style>
    main.works-grid {
      flex: 1;
    }

    /* 篩選按鈕容器 */
    .filter-buttons-container {
      max-width: 100%;
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;              /* ⭐ 防止撐開頁面 */
      -webkit-overflow-scrolling: touch;
      margin: 56px auto 20px;
      display: flex;
      justify-content: flex-start;
      scroll-snap-type: x mandatory;
      box-sizing: border-box;
    }

    /* 桌機置中 */
    @media (min-width: 769px) {
      .filter-buttons-container {
        max-width: 100%;
        justify-content: center;
        background-color:transparent;
      }
    }

    .filter-buttons {
      display: inline-flex;             /* ⭐ 改成 inline-flex，避免撐滿整個頁面 */
      gap: 12px;
      position: relative;
      min-width: max-content;           /* ⭐ 保持內容寬度，不會影響整個 body */
    }

    .filter-buttons button {
      background: none;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      font-size: var(--font-md);
      color: #243640;
      transition: color 0.3s;
      white-space: nowrap;
      letter-spacing: 0.05rem;
      scroll-snap-align: start;
      box-shadow: inset;
    }
    /* hover 顏色 */
    .filter-buttons button:hover {
      color: #E5AF3A80;  /* ⭐ 滑過去變金色 */
    }

    .filter-buttons button.active {
      color: #d3d7d9;
      font-weight: bold;
    }
    .filter-buttons button.active:hover {
      color: #E5AF3A;
    }

    .indicator {
      position: absolute;
      bottom: 0;
      height: 2px;
      background: #E5AF3A;
      transition: all 0.3s ease;
      left: 0;
      width: 0;         /* ⭐ 不要 auto，JS 會幫你算 */
      min-width: 0;     /* ⭐ 避免固定 40px 撐寬 */
    }

    /* 作品集 */
    .works-grid {
      max-width: 90%;
      margin: 0 auto;
      padding: 40px 0px 80px;
      display: grid;
      gap: 48px;
      grid-template-columns: repeat(3, 1fr);
      justify-items: center;
      grid-auto-rows: 1fr;
      justify-content: center;
    }

    .works-grid a {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      text-decoration: none;
      color: inherit;
      opacity: 1;
      transition: opacity 0.3s ease, transform 0.3s ease;
      font-size: var(--font-sm);
    }

    .works-grid a .card {
      width: 100%;
      aspect-ratio: 1/1;
      overflow: hidden;
    }

    .fade-in {
      animation: fadeIn 0.3s forwards;
    }

    .fade-out {
      animation: fadeOut 0.3s forwards;
    }

    .works-grid a img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(10px); }
    }

    /* 平板 */
    @media (max-width: 1024px) {
      .works-grid {
        grid-template-columns: repeat(2, 1fr);
        grid-auto-rows: 1fr;
        padding-bottom: 120px;
      }
    }

    /* 手機 */
    @media (max-width: 480px) {
      main.works-grid {
        min-height: calc(100vh - 60px);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 0;
      }
      main.works-grid::-webkit-scrollbar { display: none; }

      .works-grid {
        grid-template-columns: 1fr;
        grid-auto-rows: 1fr;
        max-width: 100%;
        margin: 0 auto;
        padding: 24px 12px 120px;
        gap: 24px;
      }

      .filter-buttons button {
        font-size: var(--font-md);
        padding: 6px 12px;
      }
    }

  </style>
</BaseLayout> 